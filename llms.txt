# BetterFeed - Project Metadata for LLMs

## Project Overview

BetterFeed is an AI-powered smart feed application for scrolling through condensed academic articles presented in a TikTok-style interface. Users can discover, interact with, and save articles from a curated feed powered by arXiv API for scientific preprints in physics, mathematics, computer science, and related fields.

This is a **single-repository** Next.js application (not a monorepo) that provides a full-stack solution with:
- Next.js Pages Router for frontend and most API routes
- Next.js App Router route handlers for AI SDK compatibility (in `app/api/`)
- Supabase client for database operations and authentication
- arXiv API integration for fetching scientific preprints in physics, mathematics, computer science, and related fields
- Google Gemini AI integration for intelligent article analysis and summarization
- TypeScript for type safety

## Tech Stack

### Core Framework
- **Next.js 16.0.1** - React framework with Pages Router
- **React 19.2.0** - UI library
- **TypeScript 5.x** - Type-safe JavaScript

### Database
- **Supabase** - Database hosting and authentication
- **@supabase/supabase-js 2.79.0** - Supabase JavaScript client for database operations

### Authentication
- **@supabase/supabase-js 2.79.0** - Supabase JavaScript client (handles JWT verification)
- **Zustand 5.0.0** - Client-side state management for auth

### AI Integration
- **ai** - Vercel AI SDK core package for streaming text generation
- **@ai-sdk/react** - React hooks for AI chat UI (useChat hook)
- **@ai-sdk/google** - Google Gemini provider for AI SDK (used for Gemini API compatibility)
- **marked 17.0.0** - Markdown parser for AI responses

### UI Components
- **@radix-ui/react-avatar 1.1.3** - Avatar component
- **@radix-ui/react-dialog 1.1.3** - Dialog component
- **@radix-ui/react-icons 1.1.0** - Icon library
- **@radix-ui/react-scroll-area 1.1.2** - Scroll area component
- **@radix-ui/react-slot 1.1.2** - Slot component
- **lucide-react 0.460.0** - Icon library
- **motion 12.0.0** - Animation library
- **use-stick-to-bottom 1.1.1** - Auto-scroll to bottom hook (used by Conversation component)

### Data Fetching & State
- **@tanstack/react-query 5.90.6** - Data fetching and caching
- **Zustand 5.0.0** - State management

### Utilities
- **class-variance-authority 0.7.0** - Component variant utilities
- **clsx 2.1.1** - Conditional className utility
- **react-latex-next 3.0.0** - LaTeX rendering for React components
- **katex 0.16.25** - Fast math typesetting library (dependency of react-latex-next)

### Styling
- **Tailwind CSS 4.x** - Utility-first CSS framework
- **@tailwindcss/postcss 4.x** - PostCSS integration
- Custom CSS with BetterFeed design system (in `styles/globals.css`)

### Development Tools
- **ESLint 9.x** - Code linting
- **eslint-config-next 16.0.1** - Next.js ESLint configuration

## Project Structure
```
/
├── .cursorrules              # Cursor AI rules
├── .gitignore                # Git ignore patterns
├── .env.local                # Environment variables (not in git)
├── llms.txt                  # This file - project metadata for LLMs
├── next.config.ts            # Next.js configuration
├── tsconfig.json             # TypeScript configuration
├── package.json              # Dependencies and scripts
├── components/               # React components
│   ├── ui/                   # Base UI components (Radix UI wrappers)
│   │   ├── avatar.tsx        # Avatar component
│   │   ├── badge.tsx         # Badge component
│   │   ├── button.tsx        # Button component
│   │   ├── card.tsx          # Card component
│   │   ├── dialog.tsx        # Dialog component
│   │   ├── input.tsx         # Input component
│   │   ├── scroll-area.tsx   # Scroll area component
│   │   ├── SearchBar.tsx     # Search bar component
│   │   ├── select.tsx        # Select component
│   │   └── textarea.tsx      # Textarea component
│   ├── ai-elements/          # AI SDK Elements components
│   │   ├── conversation.tsx  # Conversation component with auto-scroll
│   │   └── message.tsx       # Message component with markdown support
│   ├── auth/                 # Authentication components
│   │   ├── LoginForm.tsx     # Login form
│   │   ├── ResetPasswordForm.tsx  # Password reset form
│   │   └── SignupForm.tsx    # Signup form
│   ├── feed/                 # Feed-related components
│   │   ├── EngagementBar.tsx # Like/save/view bar
│   │   ├── FeedCard.tsx      # Feed card component
│   │   ├── InfiniteScroller.tsx  # Infinite scroll trigger
│   │   ├── PostComposer.tsx  # Post creation form
│   │   └── ReadBadge.tsx     # Read status badge
│   ├── profile/              # Profile components
│   │   ├── ProfileCard.tsx   # Profile card
│   │   └── ReadingHistorySection.tsx  # Reading history
│   ├── AIChatPanel.tsx       # AI chat panel with Gemini integration
│   ├── AppHeader.tsx         # Application header
│   ├── CategoryTabs.tsx      # Category filter tabs
│   ├── RouteGuard.tsx        # Protected route wrapper
│   └── StyleSelector.tsx     # AI style selector
├── context/                  # React context providers
│   └── toast.tsx             # Toast notification context
├── hooks/                    # Custom React hooks
│   └── useFeed.ts            # Feed data fetching hook
├── store/                    # State management
│   └── auth.ts               # Auth store (Zustand)
├── lib/                      # Shared utilities and libraries
│   ├── readingHistory.ts     # Reading history utilities
│   ├── storage.ts            # LocalStorage utilities
│   └── utils.ts              # General utilities
│   ├── db/                   # Database configuration and schema
│   │   ├── schema.ts         # TypeScript type definitions matching database schema
│   │   └── client.ts         # Supabase client initialization
│   ├── auth/                 # Authentication utilities
│   │   ├── middleware.ts     # JWT authentication middleware
│   │   └── types.ts          # Auth type definitions
│   ├── api/                  # API utilities
│   │   └── errors.ts         # Error handling utilities
│   └── services/             # External service integrations
│       ├── arxiv.ts           # arXiv API service for fetching scientific preprints
│       └── summarize.ts       # AI summary generation service using Google Gemini
├── app/                       # Next.js App Router (for AI SDK compatibility)
│   └── api/                   # App Router API routes
│       ├── chat/              # AI chat endpoint
│       │   └── route.ts       # POST /api/chat - Google Gemini chat completions (App Router route handler)
│       └── articles/         # Article fetching endpoints
│           └── fetch/          # Article fetching endpoint
│               └── route.ts   # POST /api/articles/fetch - Fetch articles from OpenAlex with AI summaries
├── pages/                     # Next.js Pages Router
│   ├── api/                   # API routes (Pages Router)
│   │   ├── auth/              # Authentication endpoints
│   │   │   ├── signup.ts      # POST /api/auth/signup
│   │   │   └── login.ts       # POST /api/auth/login
│   │   ├── posts/             # Posts endpoints
│   │   │   ├── index.ts      # GET, POST /api/posts
│   │   │   ├── [id].ts       # GET, PUT, DELETE /api/posts/[id]
│   │   │   └── [id]/username.ts  # GET /api/posts/[id]/username
│   │   └── interactions/      # Interactions endpoints
│   │       ├── index.ts      # POST /api/interactions
│   │       └── [id].ts       # GET, DELETE /api/interactions/[id]
│   ├── post/                 # Post pages
│   │   └── [id].tsx          # Individual post page
│   ├── _app.tsx              # Next.js app wrapper (with QueryClient, ToastProvider, Auth)
│   ├── _document.tsx         # Next.js document wrapper
│   ├── index.tsx             # Home page (Feed)
│   ├── login.tsx             # Login page
│   ├── signup.tsx            # Signup page
│   ├── saved.tsx             # Saved posts page
│   └── profile.tsx           # Profile page
├── types/                    # TypeScript type definitions
│   ├── api.ts               # API request/response types
│   ├── database.ts          # Database entity types
│   └── auth.ts              # Authentication types
├── sql/                      # SQL schema files
│   └── schema.sql           # Database schema SQL (reference from original Python backend)
├── scripts/                  # Utility scripts
│   └── test-api.js          # API testing script
├── public/                   # Static assets
│   ├── avatars/              # Avatar images
│   │   └── default.svg       # Default avatar
│   └── sparkle.svg           # Sparkle icon
└── styles/                   # Global styles
    └── globals.css           # Global CSS styles (BetterFeed design system)
```

## AI Features

### Chat Assistant
The application includes an AI-powered chat assistant that provides contextual analysis of articles using Google Gemini with real-time streaming responses.

**Implementation:**
- **Frontend**: `components/AIChatPanel.tsx` - Chat UI with style selection and markdown rendering using `useChat` hook from `@ai-sdk/react`
- **AI Elements**: Uses AI SDK Elements components (`components/ai-elements/conversation.tsx` and `components/ai-elements/message.tsx`) for conversation UI with automatic scrolling and scroll button
- **Backend**: `app/api/chat/route.ts` - Google Gemini API integration using AI SDK's `streamText` for streaming responses (App Router route handler required for AI SDK)
- **Streaming**: Uses Vercel AI SDK for real-time message streaming
- **Markdown Rendering**: Uses `marked` library to parse and display formatted AI responses
- **Transport**: Uses `DefaultChatTransport` from AI SDK for message handling
- **UI Components**: Conversation component provides automatic scroll-to-bottom behavior and scroll button when not at bottom
- **Note**: AI SDK requires App Router route handlers (`route.ts` in `app/api/`), even when using Pages Router for the rest of the application

**Available Styles:**
- **Professor**: Structured, insightful explanations with calm delivery. Provides clear, educational responses with numbered points when appropriate.
- **Debater**: Contrast-driven analysis surfacing pros and cons. Presents balanced perspectives and helps users critically evaluate information.

**API Route:**
- **Endpoint**: `POST /api/chat`
- **Request Body**: 
```json
  {
    "messages": "UIMessage[]",
    "post": {
      "title": "string",
      "source": "string",
      "category": "string",
      "content": "string"
    },
    "style": "professor" | "debater"
  }
```
- **Response**: Server-Sent Events (SSE) stream with UI message format
- **Streaming**: Responses are streamed in real-time using `toUIMessageStreamResponse()`

**Features:**
- Real-time streaming AI chat with article context
- Message parts support (text, tool invocations, etc.)
- Style switching during conversation
- Markdown-formatted responses with headers, lists, and emphasis
- Conversation history maintained per article
- Status management (ready, submitted, streaming, error)
- Smooth animations and accessibility features
- Automatic scroll-to-bottom with scroll button (via AI SDK Elements Conversation component)
- Empty state display when no messages

## Database Schema

### Tables

#### `profiles`
- `id` (UUID, Primary Key) - User identifier, linked to Supabase Auth
- `email` (TEXT, Unique, Not Null) - User email
- `username` (TEXT, Unique, Not Null) - Display username
- `avatar_url` (TEXT, Optional) - User avatar image URL
- `created_at` (TIMESTAMPTZ, Default: NOW) - Account creation timestamp

#### `posts`
- `id` (BIGINT, Primary Key, Auto-increment) - Post identifier
- `user_id` (UUID, Foreign Key → profiles.id) - Post creator
- `article_url` (TEXT, Not Null) - URL to original article
- `title` (TEXT, Not Null) - Article title
- `content` (TEXT, Optional) - Article summary/content
- `thumbnail_url` (TEXT, Optional) - Article thumbnail image URL
- `view_count` (INTEGER, Default: 0) - View counter
- `created_at` (TIMESTAMPTZ, Default: NOW) - Post creation timestamp
- `updated_at` (TIMESTAMPTZ, Default: NOW) - Last update timestamp (auto-updated)

#### `interactions`
- `id` (BIGINT, Primary Key, Auto-increment) - Interaction identifier
- `user_id` (UUID, Foreign Key → profiles.id) - User who interacted
- `post_id` (BIGINT, Foreign Key → posts.id) - Post that was interacted with
- `interaction_type` (TEXT, Not Null) - Either 'like' or 'save'
- `created_at` (TIMESTAMPTZ, Default: NOW) - Interaction timestamp
- Unique constraint: (user_id, post_id, interaction_type) - Prevents duplicate interactions

### Database Features
- Row Level Security (RLS) enabled on all tables via Supabase
- Foreign key constraints with CASCADE delete
- Automatic timestamp updates via database triggers
- Indexes on frequently queried columns

## API Endpoints

### Authentication
- `POST /api/auth/signup` - Register new user
  - Body: `{ email, password, username }`
  - Returns: `{ auth: User, profile: Profile }`
  - Note: Creates user in Supabase Auth and profile in database. Client-side auth store automatically signs in after signup.

- `POST /api/auth/login` - Authenticate user
  - Body: `{ email, password }`
  - Returns: `{ user: User, profile: Profile, session: Session, access_token: string }`
  - Note: Authenticates with Supabase Auth and returns session token with user profile. Client-side auth store stores token and profile.

- `GET /api/auth/profile` - Get current user's profile (requires authentication)
  - Headers: `Authorization: Bearer <token>`
  - Returns: `Profile`
  - Note: Returns the authenticated user's profile. Used for session hydration on app load.

- `PUT /api/auth/profile` - Update current user's profile (requires authentication)
  - Headers: `Authorization: Bearer <token>`
  - Body: `{ username?: string, avatar_url?: string }`
  - Returns: `Profile`
  - Note: Updates the authenticated user's profile. Only username and avatar_url can be updated.

### AI Chat
- `POST /api/chat` - Generate AI response for article discussion
  - Body: `{ messages: UIMessage[], post: Post, style: 'professor' | 'debater' }`
  - Returns: Server-Sent Events (SSE) stream with UI message format
  - Note: Uses Google Gemini API with server-side API key (App Router route handler)

### Articles
- `POST /api/articles/fetch` - Fetch scientific preprints from arXiv API with AI-generated summaries
  - Body: `{ query?: string, category?: string, perPage?: number, page?: number, sortBy?: 'relevance' | 'lastUpdatedDate' | 'submittedDate', sortOrder?: 'ascending' | 'descending', generateSummaries?: boolean }`
  - Returns: `{ articles: ArticleResponse[], meta: { count, page, per_page, total_pages } }`
  - Note: Uses arXiv API (free, no auth required) and Google Gemini for summarization
  - Default: Fetches recent articles sorted by submission date, generates summaries using Google Gemini
  - Categories: Supports arXiv categories (e.g., `cs.AI`, `math.CO`, `physics.optics`)
  - **Database Caching**: Checks database first by `article_url` before generating summaries. Only generates summaries for articles that don't exist or don't have content. Stores generated articles in database with system user (`system@betterfeed.local`) for reuse.

- `GET /api/articles/fetch` - Same as POST but uses query parameters
  - Query params: `query`, `category`, `per_page`, `page`, `sort_by`, `sort_order`, `generate_summaries`

### Posts
- `GET /api/posts` - Get all posts (public)
  - Returns: `Post[]`

- `POST /api/posts` - Create new post (requires auth)
  - Headers: `Authorization: Bearer <token>`
  - Body: `{ title, content, article_url, thumbnail_url? }`
  - Returns: `[Post]`

- `GET /api/posts/[id]` - Get post by ID (public)
  - Returns: `Post`

- `PUT /api/posts/[id]` - Update post (requires auth, owner only)
  - Headers: `Authorization: Bearer <token>`
  - Body: `{ title?, content?, thumbnail_url? }`
  - Returns: `[Post]`

- `DELETE /api/posts/[id]` - Delete post (requires auth, owner only)
  - Headers: `Authorization: Bearer <token>`
  - Returns: `[Post]`

- `GET /api/posts/[id]/username` - Get username by post ID (public)
  - Returns: `string` (username)

### Interactions
- `POST /api/interactions` - Create interaction (requires auth)
  - Headers: `Authorization: Bearer <token>`
  - Body: `{ post_id, interaction_type: 'like' | 'save' }`
  - Returns: `[Interaction]`

- `GET /api/interactions/[id]` - Get interactions by post ID (public, where `id` = postId)
  - Returns: `Interaction[]`

- `DELETE /api/interactions/[id]` - Delete interaction (requires auth, owner only, where `id` = interactionId)
  - Headers: `Authorization: Bearer <token>`
  - Returns: `[Interaction]`

## Environment Variables

Required environment variables (create `.env.local`):
```
# Server-side (used in API routes and server components)
SUPABASE_URL=your_supabase_project_url
SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_KEY=your_supabase_service_key
GEMINI_API_KEY=your_gemini_api_key_here

# Client-side (used in browser/client components)
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

- **SUPABASE_URL**: Supabase project URL (server-side)
- **SUPABASE_ANON_KEY**: Supabase anonymous/public key (server-side)
- **SUPABASE_SERVICE_KEY**: Supabase service role key (for admin operations, server-side only)
- **GEMINI_API_KEY**: Google Gemini API key for AI chat and article summarization (server-side only)
- **NEXT_PUBLIC_SUPABASE_URL**: Supabase project URL (client-side, must be prefixed with NEXT_PUBLIC_)
- **NEXT_PUBLIC_SUPABASE_ANON_KEY**: Supabase anonymous/public key (client-side, must be prefixed with NEXT_PUBLIC_)

**Note**: 
- arXiv API is free and requires no authentication. All articles are open access preprints.
- Client-side environment variables must be prefixed with `NEXT_PUBLIC_` to be accessible in the browser.
- Server-side variables (without `NEXT_PUBLIC_` prefix) are only available in API routes and server components.

## NPM Scripts

- `npm run dev` - Start development server
- `npm run build` - Build for production
- `npm run start` - Start production server
- `npm run lint` - Run ESLint
- `npm run test:api` - Run API test script

## Development Workflow

1. **Database Changes**: Update database schema in Supabase dashboard using SQL (reference: `sql/schema.sql`)
2. **Type Definitions**: Update `lib/db/schema.ts` TypeScript interfaces to match database schema changes
3. **API Routes**: 
   - Most API routes: Create routes in `pages/api/` following Next.js Pages Router conventions
   - AI SDK routes: Create route handlers in `app/api/` using App Router conventions (`route.ts` files) - required for AI SDK compatibility
4. **Authentication**: Use `withAuth()` wrapper for protected routes
5. **Error Handling**: Use `handleApiError()` utility for consistent error responses
6. **Type Safety**: Use types from `types/` directory for API requests/responses

## Key Patterns

### Authentication Middleware
Protected routes use the `withAuth()` wrapper:
```typescript
import { withAuth } from "@/lib/auth/middleware";

export default withAuth(async (req, res, authResponse) => {
  // authResponse.user contains authenticated user
  // authResponse.client contains Supabase client with user token
});
```

### Database Queries
Use Supabase client for database queries:
```typescript
import { supabase } from "@/lib/db/client";

// Get all posts
const { data: posts, error } = await supabase.from("posts").select();

// Get single post
const { data: post, error } = await supabase
  .from("posts")
  .select()
  .eq("id", postId)
  .single();

// Create post (using authenticated client)
const { data: newPost, error } = await authResponse.client
  .from("posts")
  .insert({ user_id: userId, title: "Title", article_url: "..." })
  .select()
  .single();
```

### Error Handling
Use consistent error handling:
```typescript
import { handleApiError, ApiError } from "@/lib/api/errors";

try {
  // ... code
} catch (error) {
  return handleApiError(error, res);
}
```

### AI Integration
Call Google Gemini API for article analysis:
```typescript
// In frontend components
const response = await fetch('/api/ai/chat', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    message: userMessage,
    post: currentPost,
    style: selectedStyle,
  }),
});

const data = await response.json();
// data.response contains markdown-formatted AI response
```

## Frontend Architecture

### Client-Side State Management
- **Zustand** for auth state (`store/auth.ts`)
- **TanStack Query** for server state and caching (`hooks/useFeed.ts`)
- **React Context** for toast notifications (`context/toast.tsx`)

### Routing
Next.js Pages Router with file-based routing:
- `/` - Feed page (`pages/index.tsx`)
- `/login` - Login page (`pages/login.tsx`)
- `/signup` - Signup page (`pages/signup.tsx`)
- `/post/[id]` - Individual post page (`pages/post/[id].tsx`)
- `/saved` - Saved posts page (`pages/saved.tsx`)
- `/profile` - Profile page (`pages/profile.tsx`)

### Component Structure
- Base UI components in `components/ui/` (Radix UI wrappers)
- Feature components organized by domain (auth, feed, profile)
- Shared components in `components/` root
- AI chat panel with markdown rendering in `components/AIChatPanel.tsx`

### Data Fetching
- Uses TanStack Query for posts, interactions, and categories
- Infinite scroll implemented with `useInfiniteQuery`
- Optimistic updates for interactions
  - Local storage for reading history (client-side only)
- Real-time AI responses via fetch API
  - **arXiv API Integration**: Fetches scientific preprints on-demand from arXiv API
  - Service: `lib/services/arxiv.ts` - arXiv API client for fetching preprints
  - Endpoint: `app/api/articles/fetch/route.ts` - Fetches articles and generates AI summaries
  - Hook: `hooks/useFeed.ts` - Updated to fetch from arXiv API instead of mocks
  - Rate limits: No official limits, but be respectful (recommended: 1 request per 3 seconds)
  - Coverage: Physics, mathematics, computer science, quantitative biology, and related fields
  - Full-text URLs: PDF URLs extracted from arXiv entries
  - AI Summaries: Generated using Google Gemini from abstracts
  - **Database Caching**: Articles are cached in database by `article_url`. Summaries are only generated when articles don't exist or don't have content. System user (`system@betterfeed.local`) is used to store arXiv articles for reuse across all users.

## Migration Notes

This project was migrated from:
1. **Python FastAPI backend** → Next.js API routes (Pages Router)
2. **React SPA with React Router** → Next.js Pages Router

Key migration points:
- FastAPI routes → Next.js API routes
- Python type hints → TypeScript types
- FastAPI middleware → Next.js middleware
- React Router → Next.js file-based routing
- React Router `Link`/`NavLink` → Next.js `Link`
- React Router `useNavigate`/`useLocation` → Next.js `useRouter`
- Client-side routing adapted to Next.js conventions

## Important Notes

- This is a **single-repository** project (not a monorepo)
- All database operations use Supabase client directly
- Supabase RLS policies are enforced at the database level
- Authentication uses Supabase Auth JWT tokens (Supabase handles all JWT verification)
- AI chat uses Google Gemini API with server-side API key (no client-side exposure)
- **arXiv API Integration**: Free API for scientific preprints, no authentication required
  - Fetches preprints on-demand with AI-generated summaries
  - PDF URLs extracted from arXiv entries
  - Covers physics, mathematics, computer science, and related fields
- API responses maintain compatibility with original FastAPI structure
- Database schema is managed in Supabase (SQL), TypeScript types are in `lib/db/schema.ts`
- AI responses are markdown-formatted and parsed client-side using `marked` library
- Article summaries are generated using Google Gemini from abstracts or full text content